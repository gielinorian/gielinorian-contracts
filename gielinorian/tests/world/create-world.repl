(load "../gielinorian.repl")
(load "./world-init.repl")

(begin-tx "Testing the creation of a new world")
    (use n_1fd1c7ca32908354e1f8face9d522f2b41bbd242.gielinorian-world)
    (use n_442d3e11cfe0d39859878e5b1520cd8b8c36e5db.ledger)
    (use tools.event-store)

    (env-data
        {
            'gielinorian-admin: ["gielinorian-admin"],
            'gielinorian-world-1: {
                'keys: ["gielinorian-world-1"],
                'pred: "keys-all"
            },
            'world-1-token-uri: "https://www.gielinorian.com/worlds/1.json"
        }
    )

    (env-sigs
        [
            {
                'key:"gielinorian.admin", 'caps:[],
                'key:"gielinorian-world-1", 'caps:[]
            }
        ]
    )

    (env-chain-data 
        {
            "block-height": 1
        }
    )

    (expect "World 1 token to be created"
        (create-world (read-msg "world-1-token-uri") "k:gielinorian-world-1" (read-keyset "gielinorian-world-1") [])
        true
    )

    (expect "World 1 token to be exist in the marmalade ledger"
        (token-exist (create-token-id (read-keyset "gielinorian-world-1") (read-msg "world-1-token-uri")))
        true
    )

    (expect "Supply of world 1 to be 1"
        (total-supply (create-token-id (read-keyset "gielinorian-world-1") (read-msg "world-1-token-uri")))
        1.0
    )

    (expect-failure "When minting a world that already exists"
        "Failure: Database exception: Insert: row found for key t:_Zf_-4xLsIwjH-yPwuzZ_uuLnphlnhNGPhzt90dFC3w"
        (create-world (read-msg "world-1-token-uri") "k:gielinorian-world-1" (read-keyset "gielinorian-world-1") [])
    )

    (append (env-events true))

    (expect "Existence of the fired WORLD_CREATED event" 
        (event-exist 
            {
                "height": 1,
                "module-hash": "cYV9kw7-j1DEioYWg299C7BoIA28vAPMOSvDDEVMccI",
                "name": "n_1fd1c7ca32908354e1f8face9d522f2b41bbd242.gielinorian-world.WORLD_CREATED",
                "params": ["t:_Zf_-4xLsIwjH-yPwuzZ_uuLnphlnhNGPhzt90dFC3w"]
            }
        )
        true
    )
(commit-tx)